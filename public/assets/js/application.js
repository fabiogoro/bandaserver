var sample=[{},{},{}],buffer=[],audio_context=new (window.AudioContext||window.webkitAudioContext),files,compressor=audio_context.createDynamicsCompressor();compressor.threshold.value=-50;compressor.knee.value=40;compressor.ratio.value=24;compressor.reduction.value=-20;compressor.connect(audio_context.destination);
function play(a){var b=audio_context.createBufferSource(),c=buffer[a].shift().charCodeAt(0);0===sample[folder][c]&&(c=0);b.buffer=sample[folder][c];b.connect(compressor);b.onended=function(){0!=buffer.length&&""!=buffer[a]&&play(a)};b.start(0)}$(function(){init()});function init(){files=0;var a=[".wav"];for(j=0;j<a.length;j++)load_folder(0,a[j]),load_folder(1,a[j]),load_folder(2,a[j])}function load_folder(a,b){load(a,0,b);for(var c=32;127>c;c++)load(a,c,b);for(c=127;256>c;c++)sample[a][c]=0}var total;
function load(a,b,c){files++;total=files;var d=new XMLHttpRequest;d.onload=function(){files--;$("#percent").html(Math.floor((total-files)/total*100)+"%");404===this.status?sample[a][b]||(sample[a][b]=0):audio_context.decodeAudioData(d.response,function(c){sample[a][b]=c;0===files&&loaded()},on_error)};d.open("GET","/samples_"+a+"/"+b+c,!0);d.responseType="arraybuffer";d.send()}function on_error(a){console.log("Error: "+a)};var started=0;window.addEventListener("touchend",start,!1);function start(){if(/(iPhone|iPad)/i.test(navigator.userAgent)&&!started){audio_context=new (window.AudioContext||window.webkitAudioContext);started=1;var a=audio_context.createOscillator();a.connect(audio_context.destination);a.start(0);a.disconnect()}};function chat(a){13===a.keyCode&&(a=$("#chat").val(),$("#chat").val(""),""!=a&&send(a,0))}$(document).on("click touchend",".msg",function(){var a=$(this).text();send(a,1)});var canvas;
$(function(){function a(){canvas.clearRect(0,0,d,g);var c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var f=0;f<b.frequencyBinCount;f++){var e=c[f],e=e/256,e=g*e,k=g-e-1,h=d/b.frequencyBinCount;canvas.fillStyle="hsl("+f/b.frequencyBinCount*360+", 100%, 50%)";canvas.fillRect(f*h,k,h,e)}c=new Uint8Array(b.frequencyBinCount);b.getByteTimeDomainData(c);for(f=0;f<b.frequencyBinCount;f++)e=c[f],e/=256,e*=g,k=g-e-1,h=d/b.frequencyBinCount,canvas.fillStyle="black",canvas.fillRect(f*h,
k,1,1);drawVisual=requestAnimationFrame(a)}var b=audio_context.createAnalyser();compressor.connect(b);b.fftSize=1024;new Float32Array(b.frequencyBinCount);var c=$(".visualizer")[0];canvas=c.getContext("2d");canvas.clearRect(0,0,d,g);var d=c.width,g=c.height;canvas.fillStyle="rgb(255, 255, 255)";canvas.fillRect(0,0,d,g);a()});var scheme="ws://",uri=scheme+window.document.location.host+"/",ws=new WebSocket(uri),id=0,folder=0;function send(a,b){b||(b=0);ws.send(JSON.stringify({text:a,touch:b}))}ws.onmessage=function(a){a=JSON.parse(a.data);sample_command(a)};ws.onopen=function(a){send("/samples")};
function loaded(){ws.onmessage=function(a){a=JSON.parse(a.data);sample_command(a)||(a.touch||($("#messages").prepend('<p class="msg color'+id%4+'">'+a.text+"</p>"),id+=1),"stop!"===a.text.toLowerCase()||"basta!"===a.text.toLowerCase()?buffer=[]:(a=a.text.split(""),buffer.push(a),play(buffer.length-1)));$("#messages p:nth-child(25)").remove()};$("#main").show(500);$("#loading").hide(500)}
function sample_command(a){if("/samples"===a.text.substr(0,8)){info=a.text.split("").pop();switch(info){case "s":0!=folder&&send("/samples"+folder);break;case "0":case "1":case "2":folder=info}return!0}return!1};
